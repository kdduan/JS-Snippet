<!DOCTYPE html>
<html lang="en-US">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Test Page</title>
    <script src="https://code.jquery.com/jquery-1.9.1.min.js"></script>
    <script>
        const clientId = "842517711072-bd99mv7a76njgr03dn8gnol9qikm19om.apps.googleusercontent.com";
        const clientSecret = "jDCitjD5DZBtkJ-5YWtfOYEe";
        const apiKey = "AIzaSyBxAJ6Kl2eWC-nGFtHOWG2Gw-ImzkaEmhQ";
        const accessToken = "ya29.a0AfH6SMBuY5zpRTJBz26F3QFZZwl6K1SKmG0Hi-UVb_H4EPw2fXbwQMGiJJfkp8zSXr-8VhYAGBWvwK5tNOhqUgggpVQaHtF5v3BzF3tDiKsf3V_W_B35kra8JOVWcvr89dIYB4J9SgONyVWyvh88rbtiAXqiHOTlGzqEhNl1hOs";
        const scope = "https://www.googleapis.com/auth/spreadsheets";

        var ipData;
        var enhanceData;
        var spreadsheetID = "1AOzMA60xYUxHI37kE5HOdUvuSchPK-_arOAj7IiICTQ";


        $( document ).ready(
            function() {
                $.getJSON('http://ip-api.com/json/?fields=17035263', function(data) {
                    ipData = data;
                })
                .then(
                    function() {
                        payload = {
                            "token": "d47c90a467c5465863839dee14650030",
                            "ip": ipData["query"],
                            "size": 1,
                            "threshold": .5
                        };
                        $.getJSON('https://kg.diffbot.com/kg/v3/enhance_endpoint', payload, function(data) {
                            enhanceData = data['data'];
                        })
                        .then(
                            function() {
                                // console.log(JSON.stringify("ENHANCE DATA: " + JSON.stringify(enhanceData, null, 2)));
                                // IP Data
                                var IP = ipData["query"];
                                var ISP = ipData["isp"];
                                var Proxy = ipData["proxy"].toString();
                                var Hosting = ipData["hosting"].toString();
                                var IP_City = ipData["city"];
                                var IP_Region = ipData["regionName"];
                                var IP_Country = ipData["countryCode"];
                                var IP_LatLong = ipData["lat"] + "," + ipData["lon"];
                                var IP_Postal = ipData["zip"];
                                var IP_Timezone = ipData["timezone"];

                                // initialize Diffbot data to empty strings
                                var DiffbotID = "";
                                var Name = "";
                                var Homepage = "";
                                var Description = "";
                                var Logo = "";
                                var Employees = "";
                                var Address = "";
                                var Industries = "";
                                var DiffbotFound = "FALSE";

                                // populate Diffbot data if found
                                if (enhanceData.length !== 0){
                                    DiffbotID = enhanceData[0]['entity']['id'];
                                    Name = enhanceData[0]['entity']['name'];
                                    Homepage = enhanceData[0]['entity']['homepageUri'];
                                    Description = enhanceData[0]['entity']['description'];
                                    Logo = enhanceData[0]['entity']['logo'];
                                    Employees = enhanceData[0]['entity']['nbEmployeesMin'] + "-" + enhanceData[0]['entity']['nbEmployeesMax'];
                                    Address = enhanceData[0]['entity']['location']['address'];
                                    Industries = JSON.stringify(enhanceData[0]['entity']['industries']);
                                    DiffbotFound = "TRUE";
                                }

                                // use the sheets api to add a row to the spreadsheet
                                fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetID}:batchUpdate`, {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json",
                                        "Authorization": `Bearer ${accessToken}`,
                                    },
                                    body: JSON.stringify({
                                        requests: [{
                                            appendCells: {
                                                sheetId: 0,
                                                rows: [{
                                                    values: [
                                                        {userEnteredValue: { stringValue: IP }},
                                                        {userEnteredValue: { stringValue: ISP }},
                                                        {userEnteredValue: { stringValue: Proxy }},
                                                        {userEnteredValue: { stringValue: Hosting }},
                                                        {userEnteredValue: { stringValue: IP_City }},
                                                        {userEnteredValue: { stringValue: IP_Region }},
                                                        {userEnteredValue: { stringValue: IP_Country }},
                                                        {userEnteredValue: { stringValue: IP_LatLong }},
                                                        {userEnteredValue: { stringValue: IP_Postal }},
                                                        {userEnteredValue: { stringValue: IP_Timezone }},
                                                        {userEnteredValue: { stringValue: DiffbotID }},
                                                        {userEnteredValue: { stringValue: Name }},
                                                        {userEnteredValue: { stringValue: Homepage }},
                                                        {userEnteredValue: { stringValue: Description }},
                                                        {userEnteredValue: { stringValue: Logo }},
                                                        {userEnteredValue: { stringValue: Employees }},
                                                        {userEnteredValue: { stringValue: Address }},
                                                        {userEnteredValue: { stringValue: Industries }},
                                                        {userEnteredValue: { stringValue: DiffbotFound }},
                                                    ],
                                                }],
                                                fields: "*"
                                            }
                                        }]
                                    })
                                })
                            }
                        )
                    }
                ) 
            });
        let currUrl = window.location.href;
        console.log("CURRENT URL: " + currUrl);
    </script>
    <script src="https://apis.google.com/js/api.js"></script>
</head>

<body>
    HELLO
</body>

</html>
